<!DOCTYPE html>
<html>
<head>
    <title>ç¾é£Ÿç®¡ç†ç³»ç»Ÿ | Food Helper</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root {
            --primary-color: #ff6b6b;
            --secondary-color: #4ecdc4;
            --background: #f8f9fa;
            --text-color: #2d3436;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', 'å¾®è½¯é›…é»‘', sans-serif;
        }

        body {
            margin: 0;
            background: var(--background);
            color: var(--text-color);
        }
        /* æ–°å¢æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 2rem;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            padding: 0.5rem;
        }

        .close-btn:hover {
            color: var(--primary-color);
        }


        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin: 0;
            position: relative;
            display: inline-block;
        }

        .header h1::after {
            content: '';
            display: block;
            width: 60%;
            height: 3px;
            background: var(--secondary-color);
            margin: 0.5rem auto;
        }

        /* æ·»åŠ èœå“è¡¨å• */
        .form-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 3rem;
        }

        .form-section h2 {
            color: var(--primary-color);
            margin-top: 0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-input {
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        /* é£Ÿæè¾“å…¥ç»„ */
        .element-group {
            display: grid;
            gap: 1rem;
            margin: 1rem 0;
        }

        .element-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* èœå“å¡ç‰‡ - æ¯è¡Œæ˜¾ç¤º3ä¸ª */
        .dish-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            padding: 1rem;
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 992px) {
            .dish-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dish-grid {
                grid-template-columns: 1fr;
            }
        }

        /* è°ƒæ•´å¡ç‰‡é«˜åº¦ç»Ÿä¸€ */
        .dish-card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .dish-image {
            height: 250px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .dish-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1.5rem;
        }

        .dish-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .dish-card:hover {
            transform: translateY(-5px);
        }

        /* ä¼˜åŒ–å›¾ç‰‡æ˜¾ç¤º */
        .dish-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-bottom: 3px solid var(--secondary-color);
            background: #f0f0f0;
            padding: 10px;
        }

        /* ç¾åŒ–æ“ä½œæ§ä»¶ */
        /* ä¼˜åŒ–æ“ä½œæŒ‰é’®ç»„å¸ƒå±€ */
        .action-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .action-group .btn {
            white-space: nowrap;
            padding: 0.6rem 1rem;
            flex-shrink: 0;
        }

        .custom-checkbox label {
            white-space: nowrap;
            flex-shrink: 0;
        }

        .custom-checkbox {
            position: relative;
            display: inline-block;
        }

        .custom-checkbox input {
            opacity: 0;
            position: absolute;
        }

        .custom-checkbox label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: #f0f0f0;
            transition: all 0.3s ease;
        }

        .custom-checkbox input:checked + label {
            background: var(--secondary-color);
            color: white;
        }

        .custom-checkbox label::before {
            content: '';
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #ccc;
            border-radius: 4px;
            background: white;
        }

        .custom-checkbox input:checked + label::before {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .dish-content {
            padding: 1.5rem;
        }

        .dish-title {
            margin: 0 0 1rem;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .ingredient-list {
            list-style: none;
            padding: 0;
            margin: 0 0 1rem;
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .action-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* è®¢å•çª—å£æ ·å¼ */
        .order-window {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        /* ä¿®æ”¹å…ƒç´ é¡¹å¸ƒå±€ï¼Œåœ¨å°å±å¹•ä¸Šæ”¹ä¸ºå•åˆ— */
        .element-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        @media (max-width: 768px) {
            .element-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            /* è°ƒæ•´è¡¨å•åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„è¾¹è· */
            .form-section {
                padding: 1rem;
                margin-bottom: 2rem;
            }

            /* è°ƒæ•´ç§»åŠ¨è®¾å¤‡ä¸Šçš„æŒ‰é’®å¤§å° */
            .btn {
                padding: 0.7rem 1rem;
                font-size: 0.9rem;
            }

            /* è°ƒæ•´æ ‡é¢˜å¤§å° */
            .header h1 {
                font-size: 1.8rem;
            }

            /* ä¼˜åŒ–æ¨¡æ€æ¡†åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„æ˜¾ç¤º */
            .modal-content {
                width: 95%;
                padding: 1rem;
            }

            /* è°ƒæ•´ç§»åŠ¨è®¾å¤‡ä¸Šçš„è¡¨å•å…ƒç´ é—´è· */
            .form-grid {
                gap: 0.8rem;
                margin-bottom: 1rem;
            }

            /* ä¼˜åŒ–æ“ä½œæŒ‰é’®ç»„åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„æ˜¾ç¤º */
            .action-group {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            /* è°ƒæ•´ç§»åŠ¨è®¾å¤‡ä¸Šçš„å¤é€‰æ¡†æ ·å¼ */
            .custom-checkbox label {
                padding: 0.4rem 0.8rem;
                justify-content: center;
            }
        }

        /* è¿›ä¸€æ­¥ä¼˜åŒ–è¶…å°å±å¹•çš„æ˜¾ç¤º */
        @media (max-width: 480px) {
            .form-input {
                padding: 0.6rem;
                font-size: 0.9rem;
            }

            .dish-image {
                height: 180px;
            }

            .dish-content {
                padding: 1rem;
            }
        }

        /* é”™è¯¯æç¤ºæ ·å¼ */
        .error-message {
            color: red;
            background: #ffebee;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        /* æˆåŠŸæç¤ºæ ·å¼ */
        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            background: #4CAF50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 9999;
        }

        /* é”™è¯¯æç¤ºæ ·å¼ */
        .error-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            background: #F44336;
            color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 9999;
        }

        /* æ— æ•°æ®æç¤º */
        .no-dishes {
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <h1>ç¾é£Ÿå·¥åŠ ğŸ³</h1>
    </header>

    <!-- æ·»åŠ èœå“è¡¨å• -->
    <section class="form-section">
        <h2>âœ¨ æ·»åŠ æ–°èœå“</h2>
        <form id="addForm">
            <div class="form-grid">
                <input type="text" name="name" class="form-input" placeholder="èœå“åç§°" required>
                <input type="url" name="image_url" class="form-input" placeholder="å›¾ç‰‡URL" required>
            </div>

            <div id="elements">
                <div class="element-group">
                    <div class="element-item">
                        <input type="text" class="form-input" name="elementName" placeholder="é£Ÿæåç§°" required>
                        <input type="text" class="form-input" name="quantity" placeholder="åˆ†é‡" required>
                        <input type="text" class="form-input" name="price" placeholder="ä»·æ ¼" required>
                        <button type="button" class="btn btn-danger" onclick="removeElement(this)">Ã—</button>
                    </div>
                </div>
            </div>

            <div class="action-group">
                <button type="button" class="btn btn-secondary" onclick="addElement()">â• æ·»åŠ é£Ÿæ</button>
                <button type="submit" class="btn btn-primary">ğŸš€ æäº¤èœå“</button>
            </div>
        </form>
    </section>

    <!-- èœå“å±•ç¤ºåŒº -->
    <section id="dishList"></section>

    <!-- ä¸‹å•æŒ‰é’® -->
    <div class="action-group" style="justify-content: center; margin: 3rem 0;">
        <button class="btn btn-primary" onclick="placeOrder()" style="padding: 1rem 3rem;">
            ğŸ›’ ç«‹å³ä¸‹å•
        </button>
    </div>
</div>
<!-- æ–°å¢è®¢å•æ¨¡æ€æ¡† -->
<div id="orderModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeOrderModal()">Ã—</button>
        <div id="orderContent"></div>
    </div>
</div>

<script>
    // åŸºç¡€å·¥å…·å‡½æ•°
    function escapeHTML(str) {
        if (!str) return '';
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    function escapeJS(str) {
        if (!str) return '';
        return String(str)
            .replace(/\\/g, '\\\\')
            .replace(/"/g, '\\"')
            .replace(/'/g, "\\'")
            .replace(/`/g, "\\`");
    }

    // æ˜¾ç¤ºæˆåŠŸ/é”™è¯¯æç¤º
    function showSuccess(msg) {
        const toast = document.createElement('div');
        toast.className = 'success-toast';
        toast.innerHTML = `âœ… ${msg}`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function showError(msg) {
        const toast = document.createElement('div');
        toast.className = 'error-toast';
        toast.innerHTML = `âŒ ${msg}`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    // ç§»é™¤é£Ÿæå…ƒç´ 
    function removeElement(btn) {
        btn.parentElement.parentElement.remove();
    }

    // æ·»åŠ é£Ÿæè¾“å…¥æ¡†
    function addElement() {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'element-group';

        const itemDiv = document.createElement('div');
        itemDiv.className = 'element-item';

        // æ·»åŠ é€‚é…ç§»åŠ¨è®¾å¤‡çš„æ ·å¼
        const isMobile = window.innerWidth <= 768;
        const marginStyle = isMobile ? 'margin-top:5px;' : '';

        itemDiv.innerHTML =
            '<input type="text" class="form-input" name="elementName" placeholder="é£Ÿæåç§°" required>' +
            '<input type="text" class="form-input" name="quantity" placeholder="åˆ†é‡" required>' +
            '<input type="text" class="form-input" name="price" placeholder="ä»·æ ¼" required>' +
            '<button type="button" class="btn btn-danger" onclick="removeElement(this)" ' +
            'title="åˆ é™¤é£Ÿæ" style="' + marginStyle + '">Ã—</button>';

        groupDiv.appendChild(itemDiv);
        document.getElementById('elements').appendChild(groupDiv);
    }

    // æ¸²æŸ“èœå“åˆ—è¡¨
    function renderDishes(dishes) {
        const container = document.getElementById('dishList');

        if (!Array.isArray(dishes) || dishes.length === 0) {
            container.innerHTML = '<div class="no-dishes"><h3>æš‚æ— èœå“æ•°æ®</h3><p>è¯·æ·»åŠ æ–°èœå“</p></div>';
            return;
        }

        // æ·»åŠ Gridå®¹å™¨åŒ…è£¹
        container.innerHTML = '<div class="dish-grid"></div>';
        const dishGrid = container.querySelector('.dish-grid');

        let htmlContent = '';

        for (let i = 0; i < dishes.length; i++) {
            const dish = dishes[i];
            const id = escapeHTML(dish.id || '');
            const name = escapeHTML(dish.name || 'æœªå‘½åèœå“');
            const image_url = escapeHTML(dish.image_url || '');
            const elements = dish.elements || [];

            let elementsHTML = '';
            for (let j = 0; j < elements.length; j++) {
                const element = elements[j];
                elementsHTML +=
                    '<li class="ingredient-item">' +
                    '<span>' + escapeHTML(element.name || '') + '</span>' +
                    '<span>' + escapeHTML(element.quantity || '') + ' (' + escapeHTML(element.price || '') + ')</span>' +
                    '</li>';
            }

            const imageHTML = image_url ?
                '<img src="' + image_url + '" class="dish-image" alt="' + name + '">' : '';

            htmlContent +=
                '<div class="dish-card" data-id="' + id + '" data-name="' + name + '" data-image="' + image_url + '">' +
                imageHTML +
                '<div class="dish-content">' +
                '<h3 class="dish-title">' + name + '</h3>' +
                '<ul class="ingredient-list">' + elementsHTML + '</ul>' +
                '<div class="action-group">' +
                '<div class="custom-checkbox">' +
                '<input type="checkbox" id="check-' + id + '" class="order-check" value="' + id + '">' +
                '<label for="check-' + id + '">é€‰æ‹©</label>' +
                '</div>' +
                '<button class="btn btn-secondary" onclick="editDish(\'' + escapeJS(id) + '\')">âœï¸ ç¼–è¾‘</button>' +
                '<button class="btn btn-danger" onclick="deleteDish(\'' + escapeJS(id) + '\')">ğŸ—‘ï¸ åˆ é™¤</button>' +
                '</div>' +
                '</div>' +
                '</div>';
        }

        dishGrid.innerHTML = htmlContent;
    }

    // åˆ é™¤èœå“
    async function deleteDish(id) {
        if (confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) {
            try {
                const response = await fetch('/dishes/' + id, { method: 'DELETE' });
                if (response.ok) {
                    showSuccess('èœå“å·²åˆ é™¤');
                    window.location.reload();
                } else {
                    const error = await response.json();
                    showError('åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                showError('è¯·æ±‚é”™è¯¯: ' + error.message);
                console.error('åˆ é™¤èœå“é”™è¯¯:', error);
            }
        }
    }

    // ç¼–è¾‘èœå“åŠŸèƒ½
    function editDish(id) {
        try {
            // ä»å·²åŠ è½½çš„åˆ—è¡¨æ•°æ®ä¸­è·å–èœå“è¯¦æƒ…
            const dishCard = document.querySelector('.dish-card[data-id="' + id + '"]');
            if (!dishCard) {
                showError('æ— æ³•æ‰¾åˆ°èœå“æ•°æ®');
                return;
            }

            // è·å–èœå“åç§°å’Œå›¾ç‰‡
            const name = dishCard.querySelector('.dish-title').textContent;
            let imageUrl = '';
            const imageElement = dishCard.querySelector('.dish-image');
            if (imageElement) {
                imageUrl = imageElement.src;
            }

            // è·å–é£Ÿæä¿¡æ¯
            const elements = [];
            const ingredientItems = dishCard.querySelectorAll('.ingredient-item');

            ingredientItems.forEach(function(item) {
                const nameSpan = item.querySelector('span:first-child');
                const valueSpan = item.querySelector('span:last-child');

                if (!nameSpan || !valueSpan) return;

                const name = nameSpan.textContent;
                const valueText = valueSpan.textContent;

                // æå–æ•°é‡å’Œä»·æ ¼
                let quantity = '';
                let price = '';

                const parts = valueText.split('(');
                if (parts.length >= 2) {
                    quantity = parts[0].trim();
                    price = parts[1].replace(')', '').trim();
                }

                elements.push({
                    name: name,
                    quantity: quantity,
                    price: price
                });
            });

            // å¡«å……è¡¨å•æ•°æ®
            const form = document.getElementById('addForm');
            form.querySelector('[name="name"]').value = name;
            form.querySelector('[name="image_url"]').value = imageUrl;

            // æ¸…ç©ºç°æœ‰é£Ÿæè¾“å…¥
            document.getElementById('elements').innerHTML = '';

            // å¡«å……é£Ÿæä¿¡æ¯
            elements.forEach(function(element) {
                addElement(); // æ·»åŠ æ–°è¾“å…¥æ¡†
                const lastGroup = document.querySelector('#elements .element-group:last-child');
                lastGroup.querySelector('[name="elementName"]').value = element.name;
                lastGroup.querySelector('[name="quantity"]').value = element.quantity;
                lastGroup.querySelector('[name="price"]').value = element.price;
            });

            // ä¿®æ”¹è¡¨å•æ ‡é¢˜å’ŒæŒ‰é’®æ–‡å­—
            const titleElement = form.closest('.form-section').querySelector('h2');
            if (titleElement) {
                titleElement.textContent = 'âœ¨ ç¼–è¾‘èœå“';
            }

            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
            }

            // æ·»åŠ éšè—å­—æ®µå­˜å‚¨å½“å‰ç¼–è¾‘ID
            let idInput = form.querySelector('input[name="edit_id"]');
            if (!idInput) {
                idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = 'edit_id';
                form.prepend(idInput);
            }
            idInput.value = id;

            // æ»šåŠ¨åˆ°è¡¨å•ä½ç½®
            form.scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            showError('ç¼–è¾‘æ“ä½œé”™è¯¯: ' + error.message);
            console.error('ç¼–è¾‘èœå“é”™è¯¯:', error);
        }
    }

    // ä¸‹å•åŠŸèƒ½
    async function placeOrder() {
        const checkboxes = document.querySelectorAll('.order-check:checked');
        const selected = [];

        checkboxes.forEach(function(checkbox) {
            selected.push(checkbox.value);
        });

        if (selected.length === 0) {
            showError('è¯·é€‰æ‹©è¦ä¸‹å•çš„èœå“');
            return;
        }

        try {
            const response = await fetch('/dishes/order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dish_ids: selected })
            });

            if (!response.ok) {
                throw new Error('HTTP error! status: ' + response.status);
            }

            const result = await response.json();
            if (result.code === 200) {
                showOrderResult(result.data);
            } else {
                showError('ä¸‹å•å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            showError('ä¸‹å•è¯·æ±‚é”™è¯¯: ' + error.message);
            console.error('ä¸‹å•é”™è¯¯:', error);
        }
    }

    // æ˜¾ç¤ºè®¢å•æ¨¡æ€æ¡†
    function showOrderResult(order) {
        try {
            const orderContent = document.getElementById('orderContent');
            const isMobile = window.innerWidth <= 768;

            let detailsHTML = '';

            if (order.details && Array.isArray(order.details)) {
                order.details.forEach(function(item) {
                    detailsHTML +=
                        '<div class="ingredient-item">' +
                        '<span class="ingredient-name">' + escapeHTML(item.ingredient) + '</span>' +
                        '<span class="ingredient-values" style="' + (isMobile ? 'font-size: 0.9rem;' : '') + '">' +
                        'æ•°é‡ï¼š' + (item.quantity ? item.quantity.toFixed(2) : '0.00') +
                        ' | ä»·æ ¼ï¼šÂ¥' + (item.price ? item.price.toFixed(2) : '0.00') +
                        '</span>' +
                        '</div>';
                });
            }

            const totalPrice = order.total_price ? order.total_price.toFixed(2) : '0.00';

            let modalHTML =
                '<div class="order-container ' + (isMobile ? 'mobile-view' : '') + '">' +
                '<div class="order-header">' +
                '<h1 style="' + (isMobile ? 'font-size: 1.5rem;' : '') + '">ğŸ± è®¢å•è¯¦æƒ…</h1>' +
                '<div class="total-price">' +
                'æ€»è®¡ï¼šÂ¥' + totalPrice +
                '</div>' +
                '</div>' +
                '<div class="ingredient-detail">' +
                '<h3 style="' + (isMobile ? 'font-size: 1.2rem;' : '') + '">ğŸ“¦ é£Ÿææ˜ç»†</h3>' +
                '<div class="ingredient-list">' + detailsHTML + '</div>' +
                '</div>' +
                '</div>';

            orderContent.innerHTML = modalHTML;
            document.getElementById('orderModal').style.display = 'flex';
        } catch (error) {
            showError('æ˜¾ç¤ºè®¢å•è¯¦æƒ…é”™è¯¯: ' + error.message);
            console.error('æ˜¾ç¤ºè®¢å•è¯¦æƒ…é”™è¯¯:', error);
        }
    }

    // å…³é—­è®¢å•æ¨¡æ€æ¡†
    function closeOrderModal() {
        document.getElementById('orderModal').style.display = 'none';
    }

    // æäº¤è¡¨å•å¤„ç†
    document.getElementById('addForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        try {
            const form = e.target;
            const formData = new FormData(form);
            const elements = [];

            // è·å–é£Ÿæä¿¡æ¯
            const elementItems = document.querySelectorAll('#elements .element-item');

            elementItems.forEach(function(el) {
                const nameInput = el.querySelector('[name="elementName"]');
                const quantityInput = el.querySelector('[name="quantity"]');
                const priceInput = el.querySelector('[name="price"]');

                if (nameInput && quantityInput && priceInput) {
                    elements.push({
                        name: nameInput.value,
                        quantity: quantityInput.value,
                        price: priceInput.value
                    });
                }
            });

            const isEdit = formData.has('edit_id');
            const id = formData.get('edit_id');
            const url = isEdit ? ('/dishes/' + id) : '/dishes';
            const method = isEdit ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: formData.get('name'),
                    image_url: formData.get('image_url'),
                    elements: elements
                })
            });

            if (response.ok) {
                showSuccess(isEdit ? 'èœå“æ›´æ–°æˆåŠŸï¼' : 'èœå“æ·»åŠ æˆåŠŸï¼');
                window.location.reload();
            } else {
                const error = await response.json();
                showError('æ“ä½œå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            showError('è¯·æ±‚é”™è¯¯: ' + error.message);
            console.error('æäº¤èœå“é”™è¯¯:', error);
        }
    });

    // æ£€æµ‹ç§»åŠ¨è®¾å¤‡å¹¶åº”ç”¨ä¼˜åŒ–
    function checkMobileOptimizations() {
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            // ä¼˜åŒ–ç§»åŠ¨è®¾å¤‡ä¸Šçš„èœå“å¡ç‰‡
            const cards = document.querySelectorAll('.dish-card');
            for (let i = 0; i < cards.length; i++) {
                cards[i].style.marginBottom = '1.5rem';
            }

            // ä¼˜åŒ–è®¢å•æ¨¡æ€æ¡†åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„æ˜¾ç¤º
            const container = document.querySelector('.order-container');
            if (container) {
                container.classList.add('mobile-view');
            }
        }
    }

    // æ·»åŠ çª—å£å¤§å°å˜åŒ–ç›‘å¬
    window.addEventListener('resize', checkMobileOptimizations);
    window.addEventListener('load', checkMobileOptimizations);

    // é¡µé¢åŠ è½½æ—¶è·å–èœå“åˆ—è¡¨
    window.addEventListener('load', async function() {
        try {
            const response = await fetch('/dishes');
            if (!response.ok) {
                throw new Error('HTTP error! status: ' + response.status);
            }

            const result = await response.json();
            console.log('APIè¿”å›æ•°æ®:', result);

            if (result.code === 200) {
                // æ ‡å‡†APIå“åº”æ ¼å¼
                renderDishes(result.data);
            } else if (Array.isArray(result)) {
                // ç›´æ¥è¿”å›æ•°ç»„çš„æƒ…å†µ
                renderDishes(result);
            } else {
                // å…¶ä»–æœªçŸ¥æƒ…å†µ
                console.error('æœªçŸ¥æ•°æ®æ ¼å¼:', result);
                throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
            }
        } catch (error) {
            console.error('åŠ è½½èœå“å¤±è´¥:', error);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = '<strong>åŠ è½½å¤±è´¥</strong><p>' + (error.message || 'æœªçŸ¥é”™è¯¯') + '</p>';
            document.getElementById('dishList').prepend(errorDiv);
        }
    });
</script>
</body>
</html>
